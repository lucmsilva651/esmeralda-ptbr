name: CI

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GAME_VERSION: EMERALD
      GAME_REVISION: 0
      GAME_LANGUAGE: ENGLISH
      MODERN: 0
      COMPARE: 1
      CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RUN_NUMBER: ${{ github.run_number }}
      ROM_FILE: pokeemerald_modern.gba
      CI_ROM_FILE: esmeralda-ptbr-debug.gba
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Checkout agbcc
        uses: actions/checkout@master
        with:
          path: agbcc
          repository: pret/agbcc

      - name: Install binutils
        run: |
          sudo apt install gcc-arm-none-eabi binutils-arm-none-eabi libpng-dev

      - name: Install agbcc
        run: |
          ./build.sh
          ./install.sh ../
        working-directory: agbcc

      - name: Modern
        env:
          MODERN: 1
          COMPARE: 0
        run: make -j${nproc} all

      - name: Rename to debug name
        run: mv ${ROM_FILE} ${CI_ROM_NAME}

      - name: Post to Telegram
        run: |
          if [ ! -z "${BOT_TOKEN}" ]; then
            curl -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHANNEL_ID}" \
            -F "caption=${CI_ROM_FILE}" \
            -F "document=@${CI_ROM_FILE}"
          fi
        continue-on-error: true
      
      - name: Upload to GitHub Releases
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${REPO_TOKEN}
          file: ${CI_ROM_FILE}
          asset_name: ${CI_ROM_FILE}
          tag: "release-${RUN_NUMBER}"
